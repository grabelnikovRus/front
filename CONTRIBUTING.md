Contribution Rules
==================

В основе лежат [общие правила команды](https://git.structure.pik-broker.ru/pk/core/-/tree/master/workflows).
Ниже, в этом документе, некоторые из этих правил могут быть переопределены.

Разделы:

- Git Commit
- Правила написания кода
- Настройка инструментов для работы с проектом
- Код обмена данными с API
- Добавление SVG
- Доработка Contribution Rules (этого документа)

Git Commit
----------

В дополнение к общим правилам команды, в этом репозитории мы используем [Conventional Commits](https://www.conventionalcommits.org/).
Используем [commitlint](https://commitlint.js.org/#/) для автоматической проверки правильности сообщения коммита.

Так же указываем номер задачи в Jira [в сообщении коммита](https://docs.gitlab.com/ee/integration/jira/), чтобы создавалась связь.

Правила написания кода
----------------------

Все правила, указанные во всех используемых линтерах в проекте, являются правилами написания кода, которым нужно следовать.
Благо линтеры за этим следят и помогают.

### SCSS

#### Именование классов

Мы используем правила написания CSS-классов по [БЭМ](https://ru.bem.info/methodology/).
Разделители: `block_element___modifier` — между блоком и элементом ставим одно нижнее подчёркивание `_`,
а перед модификатором — три `___`. Ключ и значение в модификаторах разделяется одним нижним подчёркиванием `_`.
Слова в многословных блоках, элементах и модификаторах разделяются при помощи snake_case.
Например `long_block_name_element_name___modifier_name_modifier_value`.

На первом уровне — блоки. На втором — элементы и модификаторы блоков. На третьем — модификаторы элементов.
На любом из этих трёх уровней могут быть псевдо-селекторы и media-запросы.
Четвёртого уровня нужно избегать, но, в крайнем случае, допустимо использовать его для псевдо-селекторов, media-запросов и [селекторов типов](https://developer.mozilla.org/en-US/docs/Web/CSS/Type_selectors) (`a`, `span` и т.п.).

#### Медиа-выражения

Мы используем подход mobile-first. Для медиа-выражений есть миксин `breakpoint`. Примеры использования в таблице:

| дизайн   | диапазон дизайна | медиа-выражение               |
|----------|------------------|-------------------------------|
| 320      | 0-374            | none                          |
| 375      | 375-413          | `@include breakpoint($xs)`    |
| 414      | 414-767          | `@include breakpoint($sm)`    |
| 768      | 768-1023         | `@include breakpoint($md)`    |
| 1024     | 1024-1279        | `@include breakpoint($lg)`    |
| 1280     | 1280-1439        | `@include breakpoint($xl)`    |
| 1440     | 1440-1919        | `@include breakpoint($xl2)`   |
| 1920     | 1920-Infinity    | `@include breakpoint($xl3)`   |

Настройка инструментов для работы с проектом
--------------------------------------------

### Автоматический запуск проверки кода с Lefthook

Для запуска линтеров перед коммитом можно использовать [lefthook](https://github.com/evilmartians/lefthook).
Он запускает линтеры только для изменившихся файлов, что сильно экономит время.

#### Установка

Устанавливаем lefthook в систему при помощи brew: `brew install lefthook`,
или [другим способом](https://github.com/evilmartians/lefthook/blob/master/docs/full_guide.md#installation).

#### Использование

Есть два варианта использования: автоматический и ручной.

- `lefthook install` — хуки установятся в `.git`, и линтеры будут запускаться при каждом коммите;
- `lefthook run pre-commit` — запускаем проверку по необходимости.

### Переменные окружения

В проекте используется несколько файлов для задания переменных окружения:

- `.env` — общие переменные;
- `.env.production`, `.env.development`, `.env.test` — переменные, уникальные для соответствующего окружения;
- `.env.example` — пример локальных переменных, нужно скопировать в файл `.env.local`;
- `.env.local` — локальные переменные, секреты; **не должен попасть в гит**

Корректность файлов проверяется [линтером](https://dotenv-linter.github.io/).

Код обмена данными с API
------------------------

Большую часть кода API-клиента мы генерируем автоматически на основе swagger схемы из файла `schema.yaml` в корне проекта. Этот файл является копией файла [схемы swagger.yaml на бэкенде](https://git.structure.pik-broker.ru/newmainsite/new-mainsite-back/-/blob/develop/http/swagger.yaml).

При изменении схемы мы обновляем наш файл `schema.yaml` и перегенерируем код клиента.

Для генерации API-клиента используется [OpenAPI Generator](https://openapi-generator.tech/).
Установить его можно при помощи `brew`: `brew install openapi-generator`,
или [другими способами](https://openapi-generator.tech/docs/installation).

Используемые команды:
- `api:fetch` — скачать свежую спеку с бека;
- `api:validate` — валидация спеки;
- `api:generate` — генерация клиента из спеки;
- `api:template` — сохранение дефолтного шаблона в папку `config/api` для внесения изменений.

В схеме есть ручные исправления, после генерации нужно проверить diff и убедиться, что нужные изменения не затёрты.

Добавление SVG
--------------

- Положить svg-файл в директорию `src/assets/svg`
- Запустить команду `yarn extract:svg`
- Новый svg компонент будет автоматически добавлен в директории `src/uikit/svg`

Доработка Contribution Rules (этого документа)
----------------------------------------------

Любой участник этого проекта может предложить любые изменения и дополнения этого документа через MR с обязательным аппрувом лида.

Не стоит добавлять сюда правило, если его можно внести в линтер.

Не стоит сильно бюрократизировать написание кода и добавлять сюда любую мелочь — большинство соглашений может оставаться устными и/или необязательными. Важно поддерживать баланс между хаосом в коде и слишком жесткой системой правил, которой сложно следовать.
Обычно, хорошим поводом добавить сюда новое правило, являет спор во время ревью кода, по итогу которого выбрали один из вариантов, даже если он не всем участникам нравится.
